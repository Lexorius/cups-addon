# Nginx reverse proxy for CUPS
# Removes Content-Security-Policy and X-Frame-Options headers
# to allow embedding in hass_ingress iframe

server {
    listen 8631;
    
    # Allow from local networks
    allow 127.0.0.1;
    allow 10.0.0.0/8;
    allow 172.16.0.0/12;
    allow 192.168.0.0/16;
    deny all;
    
    location / {
        proxy_pass http://127.0.0.1:631;
        
        # HTTP Version
        proxy_http_version 1.1;
        
        # WICHTIG: Host header auf localhost setzen für CUPS
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto http;
        
        # CSP und X-Frame-Options von upstream verstecken
        proxy_hide_header Content-Security-Policy;
        proxy_hide_header X-Frame-Options;
        
        # WICHTIG: Eigene permissive Header setzen (überschreibt alles)
        add_header X-Frame-Options "ALLOWALL" always;
        add_header Content-Security-Policy "frame-ancestors *" always;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Buffer settings
        proxy_buffering off;
    }
}
